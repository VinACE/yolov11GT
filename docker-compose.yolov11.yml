services:
  yolov11:
    build:
      context: .
      dockerfile: Dockerfile.yolov11
    container_name: yolov11-cpu
    volumes:
      - ./data:/app/data:ro
      - ./outputs:/app/outputs
      - ./models:/app/models
      - ./src:/app/src
      - ./scripts:/app/scripts
    ports:
      - "8000:8000"
      - "8501:8501"
    environment:
      - PYTHONUNBUFFERED=1
      - YOLO_VERBOSE=True
      - FRAME_PROCESS_EVERY=5
      - VISITOR_TIMEOUT_SECONDS=15
      - REID_SIM_THRESHOLD=0.71
      - FEATURE_AVG_WINDOW=5
      - MIN_CROP_HEIGHT=120
      - SAME_CAM_CONTINUITY_SECONDS=10
      - REID_TOPK=5
      - REID_GALLERY_TTL_SECONDS=60
      - REID_EMA_MOMENTUM=0.9
      - FASTREID_ENABLED=0
      - TORCHREID_MODEL_NAME=osnet_x0_75
      - TORCHREID_IMAGE_SIZE=256x128
      - TORCHREID_PIXEL_MEAN=0.485,0.456,0.406
      - TORCHREID_PIXEL_STD=0.229,0.224,0.225
    command: tail -f /dev/null
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
 
 
  yolov11-jupyter:
    build:
      context: .
      dockerfile: Dockerfile.yolov11
    container_name: yolov11-jupyter
    ports:
      - "8888:8888"
    volumes:
      - ./data:/app/data:ro
      - ./outputs:/app/outputs
      - ./models:/app/models
      - ./notebooks:/app/notebooks
    environment:
      - PYTHONUNBUFFERED=1
      - JUPYTER_ENABLE_LAB=yes
    command: >
      bash -c "pip install jupyter jupyterlab &&
               jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password=''"
    profiles:
      - jupyter

  yolov11-reset:
    build:
      context: .
      dockerfile: Dockerfile.yolov11
    container_name: yolov11-reset
    depends_on:
      - yolov11
    environment:
      - ANALYTICS_API_BASE=http://yolov11-cpu:8000
      - TZ=Asia/Kolkata
    command: >
      bash -lc "python /app/scripts/scheduler_reset.py"
    restart: unless-stopped
 
  mysql:
    image: mysql:8.0
    container_name: yolov11-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword   # 🔐 change this
      MYSQL_DATABASE: yolov11_db
      MYSQL_USER: yolouser
      MYSQL_PASSWORD: yolopassword       # 🔐 change this too
    ports:
      - "3306:3306"
    volumes:
      - ./mysql_data:/var/lib/mysql
